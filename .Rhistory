base_form = paste(target,"~",diag_str,"Age.AV1451 + Gender + Edu..Yrs. + APOE4_BIN")
braak_form = paste(target,"~",diag_str,"Age.AV1451 + Gender + Edu..Yrs. + APOE4_BIN + AV1451_PVC_Braak12_CerebGray_BL + AV1451_PVC_Braak34_CerebGray_BL + AV1451_PVC_Braak56_CerebGray_BL")
onlypattern_form = paste(target,"~",paste(pattern_columns,collapse=' + '))
pattern_form = paste(target,"~",diag_str,"Age.AV1451 + Gender + Edu..Yrs. + APOE4_BIN + ",paste(pattern_columns,collapse=' + '))
pattern_form
set.seed(825)
fitControl <- trainControl(method = "cv",
number = 10)
model = train(pattern_form, data=df_av1451, method='lasso', trControl = fitControl, preProcess=c('center','scale'))
pattern_form
train
model = train(as.formula(pattern_form), data=df_av1451, method='lasso', trControl = fitControl, preProcess=c('center','scale'))
model = train(as.formula(pattern_form), data=df_av1451, method='lasso', trControl = fitControl, preProcess=c('center','scale'))
diag_str = 'Diag.AV1451 +'
pattern_form = paste(target,"~",diag_str,"Age.AV1451 + Gender + Edu..Yrs. + APOE4_BIN + ",paste(pattern_columns,collapse=' + '))
model = train(as.formula(pattern_form), data=df_av1451, method='lasso', trControl = fitControl, preProcess=c('center','scale'))
model
form  = pattern_form
dataset= df_av1451
lambdaGrid = expand.grid(lambda = 10^seq(10, -2, length=100))
model = train(as.formula(form), data = dataset,
method='ridge',
trControl = fitControl,
tuneGrid = lambdaGrid,
preProcess=c('center', 'scale')
)
model
predict(model$finalModel)
predict(model$finalModel, type='coef')
predict(model$finalModel, type='coef', mode='norm')
predict(model$finalModel, type='coef', mode='norm')$coefficients
predict(model$finalModel, type='coef', mode='norm')$coefficients[19,]
install.packages('covTest')
library(lme4)
library(coefplot2)
library(ggplot2)
library(lmerTest)
library(pbkrtest)
library(multcomp)
library(contrast)
library(xtable)
library(sjPlot)
library(splines)
library(car)
library(stats)
library(gdata)
library(psych)
library(reshape2)
library(piecewiseSEM)
library(LambertW)
library(nnet)
library(DAAG)
library(relaimpo)
library(caret)
library(cvTools)
library(VGAM)
library(lmtest)
library(languageR)
library(stringr)
library(covTest)
source('R/LM_FUNCS.R')
# CONSTANTS
pattern_prefix = 'NSFA_'
to_factor = c('RID','ad_prior','ad_post','positive_prior','positive_post',
'diag_prior','diag_post','APOE4_BIN','APOE2_BIN','Gender',
'Diag.AV45_long','positive_prior','positive_post',
'AV45_NONTP_wcereb_BIN1.11')
to_standardize = c('CORTICAL_SUMMARY_prior','Age.AV45','Edu..Yrs.')
demog_columns = c('RID','APOE4_BIN','Diag.AV45','Age.AV45','Gender','Edu..Yrs.')
av45_columns = c('CORTICAL_SUMMARY_prior')
output_folder = 'R/output_av45_ancova/'
valid_diags = c('N','SMC','EMCI','LMCI','AD')
# IMPORT
df_av45 = read.csv('nsfa/av45_pattern_dataset.csv')
df_av45 = df_av45[which(df_av45$Diag.AV45 %in% valid_diags),]
#non.na = complete.cases(df_av45[,c(demog_columns,av45_columns)])
#df_av45 = df_av45[non.na,]
for (i in names(df_av45)){
if (i %in% to_factor){
df_av45[,eval(i)] = as.factor(as.character(df_av45[,eval(i)]))
}
}
pattern_columns = Filter(isPatternColumn,names(df_av45))
scan2_columns = Filter(isScan2Column,names(df_av45))
scan3_columns = Filter(isScan3Column,names(df_av45))
# standardize predictors
demog_normalization = preProcess(df_av45[,to_standardize])
pattern_normalization = preProcess(df_av45[,pattern_columns])
df_av45[,to_standardize] = predict(demog_normalization, df_av45[,to_standardize])
# standardize scan 2
scan2_subset = df_av45[,scan2_columns]
names(scan2_subset) = gsub("SCAN2_", "", names(scan2_subset))
scan2_subset = predict(pattern_normalization, scan2_subset)
names(scan2_subset) = gsub("NSFA_", "SCAN2_NSFA_", names(scan2_subset))
df_av45[,scan2_columns] = scan2_subset
# standardize scan 3
scan3_subset = df_av45[,scan3_columns]
names(scan3_subset) = gsub("SCAN3_", "", names(scan3_subset))
scan3_subset = predict(pattern_normalization, scan3_subset)
names(scan3_subset) = gsub("NSFA_", "SCAN3_NSFA_", names(scan3_subset))
df_av45[,scan3_columns] = scan3_subset
for (pcol in pattern_columns) {
scan2_col = paste('SCAN2_',pcol,sep='')
scan3_col = paste('SCAN3_',pcol,sep='')
scan2_change = (df_av45[,eval(scan2_col)]-df_av45[,eval(pcol)])/(df_av45$AV45_1_2_Diff)
scan3_change = (df_av45[,eval(scan3_col)]-df_av45[,eval(pcol)])/(df_av45$AV45_1_3_Diff)
all_change = scan3_change
all_change[is.na(all_change)] = scan2_change[is.na(all_change)]
df_av45[,paste('SCAN2_CHANGE_',pcol,sep='')] = scan2_change
df_av45[,paste('SCAN3_CHANGE_',pcol,sep='')] = scan3_change
df_av45[,paste('ALL_CHANGE_',pcol,sep='')] = all_change
}
for (pcol in pattern_columns) {
scan2_change_col = paste('SCAN2_CHANGE_',pcol,sep='')
scan3_change_col = paste('SCAN3_CHANGE_',pcol,sep='')
all_change_col = paste('ALL_CHANGE_',pcol,sep='')
p = ggplot(df_av45, aes_string(x=pcol, y=all_change_col)) +
geom_point(shape=1) +
geom_smooth()
print(p)
#plot(df_av45[,eval(pcol)],scan2_change,main=pcol,xlab='Baseline Factor',ylab='Annualized Change')
#abline(0,0,col='red')
}
ggplot(df_av45, aes_string(x=CORTICAL_SUMMARY_prior,y=CORTICAL_SUMMARY_change)) + geom_point(shape=1) + geom_line()
ggplot(df_av45, aes_string(x=CORTICAL_SUMMARY_prior,y=CORTICAL_SUMMARY_change)) + geom_point(shape=1) + geom_line()
ggplot(df_av45, aes(x=CORTICAL_SUMMARY_prior,y=CORTICAL_SUMMARY_change)) + geom_point(shape=1) + geom_line()
ggplot(df_av45, aes(x=CORTICAL_SUMMARY_prior,y=CORTICAL_SUMMARY_change)) + geom_point(shape=1) + geom_smooth()
library(lme4)
library(coefplot2)
library(ggplot2)
library(lmerTest)
library(pbkrtest)
library(multcomp)
library(contrast)
library(xtable)
library(sjPlot)
library(splines)
library(car)
library(stats)
library(gdata)
library(psych)
library(reshape2)
library(piecewiseSEM)
library(LambertW)
library(nnet)
library(DAAG)
library(relaimpo)
library(caret)
library(cvTools)
library(VGAM)
library(lmtest)
library(languageR)
library(stringr)
library(covTest)
source('R/LM_FUNCS.R')
# CONSTANTS
pattern_prefix = 'NSFA_'
to_factor = c('RID','ad_prior','ad_post','positive_prior','positive_post',
'diag_prior','diag_post','APOE4_BIN','APOE2_BIN','Gender',
'Diag.AV45_long','positive_prior','positive_post',
'AV45_NONTP_wcereb_BIN1.11')
to_standardize = c('CORTICAL_SUMMARY_prior','Age.AV45','Edu..Yrs.')
demog_columns = c('RID','APOE4_BIN','Diag.AV45','Age.AV45','Gender','Edu..Yrs.')
av45_columns = c('CORTICAL_SUMMARY_prior')
#target = "CORTICAL_SUMMARY_change"
#target = "UW_EF_AV45_1"
#target = "UW_EF_slope"
#target = "ADAS_AV45_1"
#target = "ADASslope_postAV45"
#target = "AVLT_AV45_1"
#target = "AVLT_slope_postAV45"
target = "UW_MEM_AV45_1"
#target = "UW_MEM_slope"
#target = "CSF_ABETA_closest_AV45_1"
#target = "CSF_TAU_closest_AV45_1"
#target = "CSF_PTAU_closest_AV45_1"
#output_folder = 'R/output/'
output_folder = 'R/output_all_diag/'
output_folder = 'R/output_neg_emci/'
all_diags = c('N','SMC','EMCI','LMCI','AD')
#valid_diags = c('N','SMC','EMCI','LMCI','AD')
#valid_diags = c('N','SMC','EMCI','LMCI')
valid_diags = c('N','SMC')
#valid_diags = c('EMCI')
#valid_diags = c('LMCI')
#time_col_prefix = 'TIMEpostAV45_ADAS'
#value_col_prefix = 'ADAScog'
#time_col_prefix = 'TIMEpostAV45_AVLT.'
#value_col_prefix = 'AVLT.'
#time_col_prefix = 'WMH_postAV45.'
#value_col_prefix = 'WMH_percentOfICV.'
time_col_prefix = 'UW_EF_postAV45_'
value_col_prefix = 'UW_EF_'
# IMPORT
df_av45 = read.csv('nsfa/av45_pattern_dataset.csv')
df_av45 = df_av45[which(df_av45$Diag.AV45 %in% valid_diags),]
non.na = complete.cases(df_av45[,c(demog_columns,av45_columns,target)])
df_av45 = df_av45[non.na,]
for (i in names(df_av45)){
if (i %in% to_factor){
df_av45[,eval(i)] = as.factor(as.character(df_av45[,eval(i)]))
}
}
pattern_columns = Filter(isPatternColumn,names(df_av45))
#pattern_columns = c('NSFA_6','NSFA_8','NSFA_0','NSFA_7','NSFA_3')
naive_columns = Filter(isNaiveColumn,names(df_av45))
# # filter by positivity
# positive_value=0
# df_av45 = df_av45[which(df_av45[,'AV45_NONTP_wcereb_BIN1.11'] == positive_value),]
# # look at histograms
# for (pcol in pattern_columns) {
#   p = ggplot(df_av45, aes_string(pcol, colour = 'positive_prior')) + geom_histogram(binwidth=0.1)
#   print(p)
# }
# standardize predictors
cross_to_standardize = c(to_standardize,pattern_columns,naive_columns,target)
cross_normalization = preProcess(df_av45[,cross_to_standardize])
df_av45[,cross_to_standardize] = predict(cross_normalization, df_av45[,cross_to_standardize])
# long_to_standardize = c(to_standardize,pattern_columns,'time','value')
# long_normalization = preProcess(df_long[,long_to_standardize])
# df_long[,long_to_standardize] = predict(long_normalization, df_long[,long_to_standardize])
# # Create long dataset
# df_long = to.long(df_av45, time_col_prefix, value_col_prefix)
# df_long$value = Gaussianize(df_long$value, type='hh', method='MLE', return.u=TRUE)
# make response normal
#df_av45[,eval(target)] = Gaussianize(df_av45[,eval(target)], type='hh', method='MLE', return.u=TRUE)
#all.addons = lapply(pattern_columns,lm.addvar)
#naive.addons = lapply(naive_columns,lm.addvar)
all.addons = paste('+',paste(pattern_columns,collapse=' + '))
naive.addons = paste('+',paste(naive_columns,collapse=' + '))
addons_form = str_replace(paste(target,"~",paste(all.addons,collapse=' ')),"\\+ ","")
diag_counts = table(df_av45$Diag.AV45)
if (length((diag_counts[diag_counts>0])) > 1) {
diag_str = 'Diag.AV45*APOE4_BIN'
} else {
diag_str = ''
}
base_form = paste(target,"~",diag_str,"Age.AV45 + Gender + Edu..Yrs. + APOE4_BIN")
nopattern_form = paste(target,"~",diag_str,"CORTICAL_SUMMARY_prior + I(CORTICAL_SUMMARY_prior^2) + Age.AV45 + Gender + Edu..Yrs. + APOE4_BIN")
onlypattern_form = paste(base_form,paste(all.addons,collapse=' '))
full_form = paste(nopattern_form,paste(all.addons,collapse=' '))
naive_form = paste(base_form,paste(naive.addons,collapse=' '))
# LASSO Penalized regression
nopattern.lasso.model = run.lasso(nopattern_form,df_av45,'RMSE')
nopattern.lasso.metric = subset(nopattern.lasso.model$results, fraction == nopattern.lasso.model$bestTune$fraction)
nopattern.lasso.coef = predict.enet(nopattern.lasso.model$finalModel, type='coefficients',s=nopattern.lasso.model$bestTune$fraction, mode='fraction')$coefficients
nopattern.lasso.coef = nopattern.lasso.coef[nopattern.lasso.coef > 0]
onlypattern.lasso.model = run.lasso(onlypattern_form,df_av45,'RMSE')
onlypattern.lasso.metric = subset(onlypattern.lasso.model$results, fraction == onlypattern.lasso.model$bestTune$fraction)
onlypattern.lasso.coef = predict.enet(onlypattern.lasso.model$finalModel, type='coefficients',s=onlypattern.lasso.model$bestTune$fraction, mode='fraction')$coefficients
onlypattern.lasso.coef = onlypattern.lasso.coef[onlypattern.lasso.coef > 0]
naive.lasso.model = run.lasso(naive_form,df_av45,'RMSE')
naive.lasso.metric = subset(naive.lasso.model$results, fraction == naive.lasso.model$bestTune$fraction)
naive.lasso.coef = predict.enet(naive.lasso.model$finalModel, type='coefficients',s=naive.lasso.model$bestTune$fraction, mode='fraction')$coefficients
naive.lasso.coef = naive.lasso.coef[naive.lasso.coef > 0]
library(lme4)
library(coefplot2)
library(ggplot2)
library(lmerTest)
library(pbkrtest)
library(multcomp)
library(contrast)
library(xtable)
library(sjPlot)
library(splines)
library(car)
library(stats)
library(gdata)
library(psych)
library(reshape2)
library(piecewiseSEM)
library(LambertW)
library(nnet)
library(DAAG)
library(relaimpo)
library(caret)
library(cvTools)
library(VGAM)
library(lmtest)
library(languageR)
library(stringr)
library(covTest)
source('R/LM_FUNCS.R')
# CONSTANTS
pattern_prefix = 'NSFA_'
to_factor = c('RID','ad_prior','ad_post','positive_prior','positive_post',
'diag_prior','diag_post','APOE4_BIN','APOE2_BIN','Gender',
'Diag.AV45_long','positive_prior','positive_post',
'AV45_NONTP_wcereb_BIN1.11')
to_standardize = c('CORTICAL_SUMMARY_prior','Age.AV45','Edu..Yrs.')
demog_columns = c('RID','APOE4_BIN','Diag.AV45','Age.AV45','Gender','Edu..Yrs.')
av45_columns = c('CORTICAL_SUMMARY_prior')
#target = "CORTICAL_SUMMARY_change"
#target = "UW_EF_AV45_1"
#target = "UW_EF_slope"
#target = "ADAS_AV45_1"
#target = "ADASslope_postAV45"
#target = "AVLT_AV45_1"
#target = "AVLT_slope_postAV45"
target = "UW_MEM_AV45_1"
#target = "UW_MEM_slope"
#target = "CSF_ABETA_closest_AV45_1"
#target = "CSF_TAU_closest_AV45_1"
#target = "CSF_PTAU_closest_AV45_1"
#output_folder = 'R/output/'
output_folder = 'R/output_all_diag/'
output_folder = 'R/output_neg_emci/'
all_diags = c('N','SMC','EMCI','LMCI','AD')
#valid_diags = c('N','SMC','EMCI','LMCI','AD')
#valid_diags = c('N','SMC','EMCI','LMCI')
valid_diags = c('N','SMC')
#valid_diags = c('EMCI')
#valid_diags = c('LMCI')
#time_col_prefix = 'TIMEpostAV45_ADAS'
#value_col_prefix = 'ADAScog'
#time_col_prefix = 'TIMEpostAV45_AVLT.'
#value_col_prefix = 'AVLT.'
#time_col_prefix = 'WMH_postAV45.'
#value_col_prefix = 'WMH_percentOfICV.'
time_col_prefix = 'UW_EF_postAV45_'
value_col_prefix = 'UW_EF_'
# IMPORT
df_av45 = read.csv('nsfa/av45_pattern_dataset.csv')
df_av45 = df_av45[which(df_av45$Diag.AV45 %in% valid_diags),]
non.na = complete.cases(df_av45[,c(demog_columns,av45_columns,target)])
df_av45 = df_av45[non.na,]
for (i in names(df_av45)){
if (i %in% to_factor){
df_av45[,eval(i)] = as.factor(as.character(df_av45[,eval(i)]))
}
}
pattern_columns = Filter(isPatternColumn,names(df_av45))
#pattern_columns = c('NSFA_6','NSFA_8','NSFA_0','NSFA_7','NSFA_3')
naive_columns = Filter(isNaiveColumn,names(df_av45))
# # filter by positivity
# positive_value=0
# df_av45 = df_av45[which(df_av45[,'AV45_NONTP_wcereb_BIN1.11'] == positive_value),]
# # look at histograms
# for (pcol in pattern_columns) {
#   p = ggplot(df_av45, aes_string(pcol, colour = 'positive_prior')) + geom_histogram(binwidth=0.1)
#   print(p)
# }
# standardize predictors
cross_to_standardize = c(to_standardize,pattern_columns,naive_columns,target)
cross_normalization = preProcess(df_av45[,cross_to_standardize])
df_av45[,cross_to_standardize] = predict(cross_normalization, df_av45[,cross_to_standardize])
# long_to_standardize = c(to_standardize,pattern_columns,'time','value')
# long_normalization = preProcess(df_long[,long_to_standardize])
# df_long[,long_to_standardize] = predict(long_normalization, df_long[,long_to_standardize])
# # Create long dataset
# df_long = to.long(df_av45, time_col_prefix, value_col_prefix)
# df_long$value = Gaussianize(df_long$value, type='hh', method='MLE', return.u=TRUE)
# make response normal
#df_av45[,eval(target)] = Gaussianize(df_av45[,eval(target)], type='hh', method='MLE', return.u=TRUE)
#all.addons = lapply(pattern_columns,lm.addvar)
#naive.addons = lapply(naive_columns,lm.addvar)
all.addons = paste('+',paste(pattern_columns,collapse=' + '))
naive.addons = paste('+',paste(naive_columns,collapse=' + '))
addons_form = str_replace(paste(target,"~",paste(all.addons,collapse=' ')),"\\+ ","")
diag_counts = table(df_av45$Diag.AV45)
if (length((diag_counts[diag_counts>0])) > 1) {
diag_str = 'Diag.AV45*APOE4_BIN + '
} else {
diag_str = ''
}
base_form = paste(target,"~",diag_str,"Age.AV45 + Gender + Edu..Yrs. + APOE4_BIN")
nopattern_form = paste(target,"~",diag_str,"CORTICAL_SUMMARY_prior + I(CORTICAL_SUMMARY_prior^2) + Age.AV45 + Gender + Edu..Yrs. + APOE4_BIN")
onlypattern_form = paste(base_form,paste(all.addons,collapse=' '))
full_form = paste(nopattern_form,paste(all.addons,collapse=' '))
naive_form = paste(base_form,paste(naive.addons,collapse=' '))
# LASSO Penalized regression
nopattern.lasso.model = run.lasso(nopattern_form,df_av45,'RMSE')
nopattern.lasso.metric = subset(nopattern.lasso.model$results, fraction == nopattern.lasso.model$bestTune$fraction)
nopattern.lasso.coef = predict.enet(nopattern.lasso.model$finalModel, type='coefficients',s=nopattern.lasso.model$bestTune$fraction, mode='fraction')$coefficients
nopattern.lasso.coef = nopattern.lasso.coef[nopattern.lasso.coef > 0]
onlypattern.lasso.model = run.lasso(onlypattern_form,df_av45,'RMSE')
onlypattern.lasso.metric = subset(onlypattern.lasso.model$results, fraction == onlypattern.lasso.model$bestTune$fraction)
onlypattern.lasso.coef = predict.enet(onlypattern.lasso.model$finalModel, type='coefficients',s=onlypattern.lasso.model$bestTune$fraction, mode='fraction')$coefficients
onlypattern.lasso.coef = onlypattern.lasso.coef[onlypattern.lasso.coef > 0]
naive.lasso.model = run.lasso(naive_form,df_av45,'RMSE')
naive.lasso.metric = subset(naive.lasso.model$results, fraction == naive.lasso.model$bestTune$fraction)
naive.lasso.coef = predict.enet(naive.lasso.model$finalModel, type='coefficients',s=naive.lasso.model$bestTune$fraction, mode='fraction')$coefficients
naive.lasso.coef = naive.lasso.coef[naive.lasso.coef > 0]
onlypattern.lasso.metric
library(lme4)
library(coefplot2)
library(ggplot2)
library(lmerTest)
library(pbkrtest)
library(multcomp)
library(contrast)
library(xtable)
library(sjPlot)
library(splines)
library(car)
library(stats)
library(gdata)
library(psych)
library(reshape2)
library(piecewiseSEM)
library(LambertW)
library(nnet)
library(DAAG)
library(relaimpo)
library(caret)
library(cvTools)
library(VGAM)
library(lmtest)
library(languageR)
library(stringr)
library(covTest)
source('R/LM_FUNCS.R')
# CONSTANTS
pattern_prefix = 'NSFA_'
to_factor = c('RID','ad_prior','ad_post','positive_prior','positive_post',
'diag_prior','diag_post','APOE4_BIN','APOE2_BIN','Gender',
'Diag.AV45_long','positive_prior','positive_post',
'AV45_NONTP_wcereb_BIN1.11')
to_standardize = c('CORTICAL_SUMMARY_prior','Age.AV45','Edu..Yrs.')
demog_columns = c('RID','APOE4_BIN','Diag.AV45','Age.AV45','Gender','Edu..Yrs.')
av45_columns = c('CORTICAL_SUMMARY_prior')
#target = "CORTICAL_SUMMARY_change"
#target = "UW_EF_AV45_1"
#target = "UW_EF_slope"
#target = "ADAS_AV45_1"
#target = "ADASslope_postAV45"
#target = "AVLT_AV45_1"
#target = "AVLT_slope_postAV45"
target = "UW_MEM_AV45_1"
#target = "UW_MEM_slope"
#target = "CSF_ABETA_closest_AV45_1"
#target = "CSF_TAU_closest_AV45_1"
#target = "CSF_PTAU_closest_AV45_1"
#output_folder = 'R/output/'
output_folder = 'R/output_all_diag/'
output_folder = 'R/output_neg_emci/'
all_diags = c('N','SMC','EMCI','LMCI','AD')
#valid_diags = c('N','SMC','EMCI','LMCI','AD')
#valid_diags = c('N','SMC','EMCI','LMCI')
valid_diags = c('N')
#valid_diags = c('EMCI')
#valid_diags = c('LMCI')
#time_col_prefix = 'TIMEpostAV45_ADAS'
#value_col_prefix = 'ADAScog'
#time_col_prefix = 'TIMEpostAV45_AVLT.'
#value_col_prefix = 'AVLT.'
#time_col_prefix = 'WMH_postAV45.'
#value_col_prefix = 'WMH_percentOfICV.'
time_col_prefix = 'UW_EF_postAV45_'
value_col_prefix = 'UW_EF_'
# IMPORT
df_av45 = read.csv('nsfa/av45_pattern_dataset.csv')
df_av45 = df_av45[which(df_av45$Diag.AV45 %in% valid_diags),]
non.na = complete.cases(df_av45[,c(demog_columns,av45_columns,target)])
df_av45 = df_av45[non.na,]
for (i in names(df_av45)){
if (i %in% to_factor){
df_av45[,eval(i)] = as.factor(as.character(df_av45[,eval(i)]))
}
}
pattern_columns = Filter(isPatternColumn,names(df_av45))
#pattern_columns = c('NSFA_6','NSFA_8','NSFA_0','NSFA_7','NSFA_3')
naive_columns = Filter(isNaiveColumn,names(df_av45))
# # filter by positivity
# positive_value=0
# df_av45 = df_av45[which(df_av45[,'AV45_NONTP_wcereb_BIN1.11'] == positive_value),]
# # look at histograms
# for (pcol in pattern_columns) {
#   p = ggplot(df_av45, aes_string(pcol, colour = 'positive_prior')) + geom_histogram(binwidth=0.1)
#   print(p)
# }
# standardize predictors
cross_to_standardize = c(to_standardize,pattern_columns,naive_columns,target)
cross_normalization = preProcess(df_av45[,cross_to_standardize])
df_av45[,cross_to_standardize] = predict(cross_normalization, df_av45[,cross_to_standardize])
# long_to_standardize = c(to_standardize,pattern_columns,'time','value')
# long_normalization = preProcess(df_long[,long_to_standardize])
# df_long[,long_to_standardize] = predict(long_normalization, df_long[,long_to_standardize])
# # Create long dataset
# df_long = to.long(df_av45, time_col_prefix, value_col_prefix)
# df_long$value = Gaussianize(df_long$value, type='hh', method='MLE', return.u=TRUE)
# make response normal
#df_av45[,eval(target)] = Gaussianize(df_av45[,eval(target)], type='hh', method='MLE', return.u=TRUE)
#all.addons = lapply(pattern_columns,lm.addvar)
#naive.addons = lapply(naive_columns,lm.addvar)
all.addons = paste('+',paste(pattern_columns,collapse=' + '))
naive.addons = paste('+',paste(naive_columns,collapse=' + '))
addons_form = str_replace(paste(target,"~",paste(all.addons,collapse=' ')),"\\+ ","")
diag_counts = table(df_av45$Diag.AV45)
if (length((diag_counts[diag_counts>0])) > 1) {
diag_str = 'Diag.AV45*APOE4_BIN + '
} else {
diag_str = ''
}
base_form = paste(target,"~",diag_str,"Age.AV45 + Gender + Edu..Yrs. + APOE4_BIN")
nopattern_form = paste(target,"~",diag_str,"CORTICAL_SUMMARY_prior + I(CORTICAL_SUMMARY_prior^2) + Age.AV45 + Gender + Edu..Yrs. + APOE4_BIN")
onlypattern_form = paste(base_form,paste(all.addons,collapse=' '))
full_form = paste(nopattern_form,paste(all.addons,collapse=' '))
naive_form = paste(base_form,paste(naive.addons,collapse=' '))
# LASSO Penalized regression
nopattern.lasso.model = run.lasso(nopattern_form,df_av45,'RMSE')
nopattern.lasso.metric = subset(nopattern.lasso.model$results, fraction == nopattern.lasso.model$bestTune$fraction)
nopattern.lasso.coef = predict.enet(nopattern.lasso.model$finalModel, type='coefficients',s=nopattern.lasso.model$bestTune$fraction, mode='fraction')$coefficients
nopattern.lasso.coef = nopattern.lasso.coef[nopattern.lasso.coef > 0]
onlypattern.lasso.model = run.lasso(onlypattern_form,df_av45,'RMSE')
onlypattern.lasso.metric = subset(onlypattern.lasso.model$results, fraction == onlypattern.lasso.model$bestTune$fraction)
onlypattern.lasso.coef = predict.enet(onlypattern.lasso.model$finalModel, type='coefficients',s=onlypattern.lasso.model$bestTune$fraction, mode='fraction')$coefficients
onlypattern.lasso.coef = onlypattern.lasso.coef[onlypattern.lasso.coef > 0]
naive.lasso.model = run.lasso(naive_form,df_av45,'RMSE')
naive.lasso.metric = subset(naive.lasso.model$results, fraction == naive.lasso.model$bestTune$fraction)
naive.lasso.coef = predict.enet(naive.lasso.model$finalModel, type='coefficients',s=naive.lasso.model$bestTune$fraction, mode='fraction')$coefficients
naive.lasso.coef = naive.lasso.coef[naive.lasso.coef > 0]
